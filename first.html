<!DOCTYPE html>
<html>
<head>
    <title>Marine Distance Matrix Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }

        /* Layout */
        #main-container { display: flex; width: 100vw; height: 100vh; }

        /* Map Side */
        #map-side { position: relative; flex: 1; border-right: 2px solid #ddd; background: #aad3df; }
        #map { width: 100%; height: 100%; }

        /* Table Side */
        #table-side { flex: 1; overflow: auto; background: #ffffff; padding: 20px; box-sizing: border-box; }

        /* Floating Instructions */
        #floating-controls {
            position: absolute; top: 20px; left: 60px; z-index: 1000;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);
            padding: 15px; border-radius: 10px; border: 1px solid rgba(0,0,0,0.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15); font-size: 0.85em; width: 220px;
        }

        /* Matrix Styling */
        table { border-collapse: collapse; margin-top: 130px; margin-left: 10px; }

        /* Header Rotation Fix */
        thead th:not(:first-child) {
            height: 120px;
            vertical-align: bottom;
            position: relative;
            min-width: 45px;
            padding: 0;
            border-bottom: 1px solid #e0e6ed;
        }

        .rotate-wrapper {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: rotate(-90deg);
            transform-origin: middle left;
            width: 20px;
            white-space: nowrap;
            text-align: left;
        }

        .rotate-wrapper span { font-weight: 700; font-size: 0.95em; }

        /* Row Styles */
        th, td { border: 1px solid #e0e6ed; padding: 8px; text-align: center; }
        th:first-child { min-width: 180px; vertical-align: bottom; padding-bottom: 10px; font-size: 1.1em; }

        .name-cell-content { display: flex; align-items: center; gap: 8px; }
        .name-input { flex-grow: 1; border: none; background: transparent; font-weight: bold; outline: none; font-size: 1em; }
        .name-cell-active { background: #f8f9fa !important; }

        .delete-btn {
            background: #ff7675; color: white; border: none; border-radius: 4px;
            width: 22px; height: 22px; cursor: pointer; display: flex; align-items: center; justify-content: center;
            font-size: 16px; font-weight: bold; transition: 0.2s;
        }
        .delete-btn:hover { background: #d63031; }

        .diagonal { background-color: #f8f9fa; color: #ced4da; }
        .dist-cell { font-family: 'Courier New', monospace; font-weight: bold; font-size: 1.1em; transition: 0.1s; cursor: crosshair; }

        .reset-btn { margin-top: 12px; padding: 8px 15px; cursor: pointer; background: #2d3436; color: white; border: none; border-radius: 5px; width: 100%; font-weight: 600; }
        .reset-btn:hover { background: #000; }
    </style>
</head>
<body>

<div id="main-container">
    <div id="map-side">
        <div id="floating-controls">
            <strong>Marine Distance Matrix</strong><br><br>
            üìç <b>Click map</b> to add mark<br>
            üñêÔ∏è <b>Drag marks</b> to move<br>
            ‚ö° <b>Hover names</b> to highlight web<br>
            üóëÔ∏è <b>Red button</b> in table to delete<br>
            <button class="reset-btn" onclick="clearAll()">Reset All Data</button>
        </div>
        <div id="map"></div>
    </div>

    <div id="table-side">
        <table id="matrix">
            <thead><tr id="header-row"><th>Location</th></tr></thead>
            <tbody id="matrix-body"></tbody>
        </table>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    const map = L.map('map').setView([52, 4], 6); // Centered near the area in your screenshot
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    let locations = JSON.parse(localStorage.getItem('marine_locations')) || [];
    let lines = {};
    const METERS_TO_NM = 0.000539957;

    if (locations.length > 0) {
        initFromStorage();
    }

    map.on('click', async function(e) {
        const color = `hsl(${Math.random() * 360}, 70%, 45%)`;
        let name = `Mark ${locations.length + 1}`;

        try {
            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e.latlng.lat}&lon=${e.latlng.lng}`);
            const data = await res.json();
            if(data.address) {
                name = data.address.city || data.address.water || data.address.town || data.address.state || name;
            }
        } catch (err) {}

        locations.push({ name, lat: e.latlng.lat, lng: e.latlng.lng, color });
        saveAndRefresh();
    });

    function initFromStorage() {
        locations.forEach((loc, i) => loc.marker = createMarker(loc, i));
        drawAllCourses();
        renderMatrix();
        zoomToFit();
    }

    function createMarker(loc, index) {
        const marker = L.marker([loc.lat, loc.lng], {
            draggable: true,
            icon: L.divIcon({
                className: '',
                html: `<div style="background-color:${loc.color}; width:14px; height:14px; border:2px solid white; border-radius:50%; box-shadow:0 2px 5px rgba(0,0,0,0.4);"></div>`,
                iconSize: [18, 18], iconAnchor: [9, 9]
            })
        }).addTo(map).bindTooltip(loc.name);

        marker.on('drag', function(e) {
            const newPos = e.target.getLatLng();
            locations[index].lat = newPos.lat;
            locations[index].lng = newPos.lng;
            drawAllCourses();
            renderMatrix();
        });

        marker.on('dragend', saveToStorage);
        return marker;
    }

    function deleteLocation(index) {
        if (locations[index].marker) map.removeLayer(locations[index].marker);
        locations.splice(index, 1);
        saveAndRefresh();
    }

    function saveToStorage() {
        const storageData = locations.map(l => ({ name: l.name, lat: l.lat, lng: l.lng, color: l.color }));
        localStorage.setItem('marine_locations', JSON.stringify(storageData));
    }

    function saveAndRefresh() {
        saveToStorage();
        // Clear everything
        locations.forEach(l => { if (l.marker) map.removeLayer(l.marker); });
        for (let key in lines) { map.removeLayer(lines[key]); }
        lines = {};

        // Rebuild
        locations.forEach((l, i) => l.marker = createMarker(l, i));
        drawAllCourses();
        renderMatrix();
        zoomToFit();
    }

    function zoomToFit() {
        if (locations.length < 2) return;
        const bounds = L.latLngBounds(locations.map(loc => [loc.lat, loc.lng]));
        map.fitBounds(bounds, { padding: [80, 80] });
    }

    function drawAllCourses() {
        for (let key in lines) { map.removeLayer(lines[key]); }
        lines = {};
        for (let i = 0; i < locations.length; i++) {
            for (let j = i + 1; j < locations.length; j++) {
                const poly = L.polyline([[locations[i].lat, locations[i].lng], [locations[j].lat, locations[j].lng]], {
                    color: locations[i].color,
                    weight: 2,
                    opacity: 0.15,
                    dashArray: '5, 5'
                }).addTo(map);
                lines[`${i}-${j}`] = lines[`${j}-${i}`] = poly;
            }
        }
    }

    function highlightLine(i, j, active) {
        const key = `${i}-${j}`;
        if (lines[key]) {
            const baseColor = locations[Math.min(i,j)].color;
            lines[key].setStyle(active ?
                { color: baseColor, weight: 5, opacity: 1, dashArray: null } :
                { color: baseColor, weight: 2, opacity: 0.15, dashArray: '5, 5' });
            if (active) lines[key].bringToFront();
        }
    }

    function highlightAllOutgoing(index, active) {
        locations.forEach((_, otherIndex) => {
            if (index !== otherIndex) highlightLine(index, otherIndex, active);
        });
    }

    function updateName(index, newName) {
        locations[index].name = newName;
        saveToStorage();
        if(locations[index].marker) locations[index].marker.setTooltipContent(newName);
        // Live update rotated headers
        const headerLabels = document.querySelectorAll('.rotate-wrapper span');
        if (headerLabels[index]) headerLabels[index].innerText = newName;
    }

    function renderMatrix() {
        const headerRow = document.getElementById('header-row');
        const body = document.getElementById('matrix-body');
        headerRow.innerHTML = '<th>Location</th>';
        body.innerHTML = '';

        // Render Rotated Headers
        locations.forEach(loc => {
            const th = document.createElement('th');
            th.innerHTML = `<div class="rotate-wrapper" style="color:${loc.color}"><span>${loc.name}</span></div>`;
            headerRow.appendChild(th);
        });

        // Render Rows
        locations.forEach((rowLoc, i) => {
            const tr = document.createElement('tr');
            const nameTd = document.createElement('td');
            nameTd.style.borderLeft = `6px solid ${rowLoc.color}`;

            nameTd.onmouseenter = () => { nameTd.classList.add('name-cell-active'); highlightAllOutgoing(i, true); };
            nameTd.onmouseleave = () => { nameTd.classList.remove('name-cell-active'); highlightAllOutgoing(i, false); };

            const cellDiv = document.createElement('div');
            cellDiv.className = 'name-cell-content';
            const delBtn = document.createElement('button');
            delBtn.className = 'delete-btn';
            delBtn.innerHTML = '&times;';
            delBtn.onclick = () => deleteLocation(i);
            const input = document.createElement('input');
            input.className = 'name-input';
            input.value = rowLoc.name;
            input.oninput = (e) => updateName(i, e.target.value);

            cellDiv.appendChild(input);
            cellDiv.appendChild(delBtn);
            nameTd.appendChild(cellDiv);
            tr.appendChild(nameTd);

            // Distance Cells
            locations.forEach((colLoc, j) => {
                const td = document.createElement('td');
                if (i === j) {
                    td.innerText = '-';
                    td.className = 'diagonal';
                } else {
                    const distNM = Math.round(L.latLng(rowLoc.lat, rowLoc.lng).distanceTo(L.latLng(colLoc.lat, colLoc.lng)) * METERS_TO_NM);
                    td.innerText = distNM;
                    td.className = 'dist-cell';
                    td.onmouseenter = () => highlightLine(i, j, true);
                    td.onmouseleave = () => highlightLine(i, j, false);
                }
                tr.appendChild(td);
            });
            body.appendChild(tr);
        });
    }

    function clearAll() {
        if(confirm("This will delete all markers and clear your history. Proceed?")) {
            localStorage.removeItem('marine_locations');
            location.reload();
        }
    }
</script>
</body>
</html>